appId: keepass2android.keepass2android_nonet
---
# Test: KeeShare Wrong Password Error Handling
# Tests that wrong password errors are handled gracefully with helpful messages.
#
# Prerequisites:
#   - keeshare-test-main.kdbx in /sdcard/Download/ (password: test123)
#   - keeshare-test-export.kdbx in /sdcard/Download/ (password: share123)
#   - A KeeShare import already configured (run keeshare_import_flow.yaml first,
#     or this test will set one up with wrong password)
#
# Run with: maestro test e2e-tests/.maestro/keeshare_wrong_password.yaml

- launchApp:
    clearState: true

# Wait for app to load
- extendedWaitUntil:
    visible: ".*database.*|.*Open.*|.*Unlock.*"
    timeout: 10000

# Open the test main database
- tapOn:
    text: "Open file"
    optional: true
- tapOn:
    text: "Change database"
    optional: true

# Navigate to Downloads
- runFlow:
    when:
      visible: ".*Open.*|.*Browse.*"
    commands:
      - tapOn:
          id: ".*fab.*|.*open.*"
          optional: true

- extendedWaitUntil:
    visible: ".*Download.*|.*Recent.*|.*Files.*"
    timeout: 5000

- tapOn:
    text: "Downloads"
    optional: true
- tapOn:
    text: "Download"
    optional: true

# Select the test main database
- tapOn:
    text: "keeshare-test-main"
    optional: true
- tapOn:
    text: ".*keeshare-test-main.*"
    optional: true

# Wait for password screen and enter password
- extendedWaitUntil:
    visible: ".*Password.*|.*Unlock.*"
    timeout: 5000

- tapOn:
    text: "Password"
    optional: true
- inputText: "test123"
- hideKeyboard
- tapOn: "Unlock"

# Wait for database to open
- extendedWaitUntil:
    visible: ".*Sample Entry.*|.*Root.*|.*group.*"
    timeout: 15000

# Dismiss dialogs
- tapOn:
    text: "OK"
    optional: true
- tapOn:
    text: "I don't care"
    optional: true

# Navigate to KeeShare settings
- tapOn:
    id: ".*overflow.*|.*more.*"
    optional: true
- tapOn:
    text: "More options"
    optional: true
- tapOn: "Settings"

- extendedWaitUntil:
    visible: "Database"
    timeout: 5000
- tapOn: "Database"

- scrollUntilVisible:
    element: "Configure KeeShare groups"
    direction: DOWN
    timeout: 10000
- tapOn:
    text: "Configure KeeShare groups"

# Wait for KeeShare screen
- extendedWaitUntil:
    visible: ".*KeeShare.*"
    timeout: 5000

# If no KeeShare groups exist, create one with wrong password
- runFlow:
    when:
      visible: ".*No KeeShare.*"
    commands:
      # Tap FAB to add
      - tapOn:
          id: ".*fab.*add.*"
      - extendedWaitUntil:
          visible: ".*Add KeeShare.*"
          timeout: 5000
      # Enter group name
      - tapOn:
          id: ".*edit_new_group_name.*"
          optional: true
      - inputText: "Test Wrong Password"
      - hideKeyboard
      # Tap Browse
      - tapOn:
          text: "Browse"
      # Select file
      - extendedWaitUntil:
          visible: ".*Download.*"
          timeout: 5000
      - tapOn:
          text: "Downloads"
          optional: true
      - tapOn:
          text: "keeshare-test-export"
      # Wait for return
      - extendedWaitUntil:
          visible: ".*KeeShare.*"
          timeout: 5000

# Now we should have a KeeShare group. Edit it to set wrong password.
- tapOn:
    text: "Edit"

- extendedWaitUntil:
    visible: ".*Edit KeeShare.*|.*Password.*"
    timeout: 5000

# Clear any existing password and enter wrong one
- tapOn:
    id: ".*edit_password.*"
- clearText
- inputText: "wrong123"
- hideKeyboard

- tapOn:
    text: "OK"

# Wait for save
- extendedWaitUntil:
    visible: ".*Sync now.*"
    timeout: 5000

# Now sync - this should fail with wrong password
- tapOn:
    text: "Sync now"

# Wait for error message
- extendedWaitUntil:
    visible: ".*[Ww]rong password.*|.*[Ee]rror.*|.*[Ff]ailed.*"
    timeout: 15000

# Verify we see a user-friendly error about wrong password
- assertVisible:
    text: ".*[Ww]rong password.*|.*Edit.*"

# Now fix the password
- tapOn:
    text: "Edit"

- extendedWaitUntil:
    visible: ".*Edit KeeShare.*"
    timeout: 5000

- tapOn:
    id: ".*edit_password.*"
- clearText
- inputText: "share123"
- hideKeyboard

- tapOn:
    text: "OK"

# Sync again - should succeed now
- extendedWaitUntil:
    visible: ".*Sync now.*"
    timeout: 5000

- tapOn:
    text: "Sync now"

# Wait for success
- extendedWaitUntil:
    visible: ".*sync complete.*|.*Password.*configured.*"
    timeout: 15000

# Test passed - error handling works correctly
